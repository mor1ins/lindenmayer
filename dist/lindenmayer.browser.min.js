!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):(t=t||self).LSystem=s()}(this,function(){"use strict";function t(t){var s,i=t[0].match(/(.+)<(.)/),o=t[0].match(/(.)>(.+)/);if(null===i&&null===o)return t;var r=t[1].successor||t[1].successors?t[1]:{successor:t[1]};return null!==i&&(s=i[2],r.leftCtx=i[1]),null!==o&&(s=o[1],r.rightCtx=o[2]),[s,r]}function s(t){if("string"!=typeof t&&t instanceof String==!1)return t;for(var s=[],i=0;i<t.length;i++){var o=t[i];s.push({symbol:o})}return s}function i(t,i){return t[1]=function t(i,o){if(i.hasOwnProperty("successors"))for(var r=0;r<i.successors.length;r++)i.successors[r]=t(i.successors[r],o);else!1===i.hasOwnProperty("successor")&&(i={successor:i});return o&&i.hasOwnProperty("successor")&&(i.successor=s(i.successor)),i}(t[1],i),t}Object.entries||(Object.entries=function(t){for(var s=Object.keys(t),i=s.length,o=new Array(i);i--;)o[i]=[s[i],t[s[i]]];return o});var LSystem=function(){function LSystem(t){var s=t.axiom,i=void 0===s?"":s,o=t.productions,r=t.finals,e=t.branchSymbols,n=void 0===e?"[]":e,c=t.ignoredSymbols,a=void 0===c?"+-&^/|\\":c,h=t.allowClassicSyntax,u=void 0===h||h,l=t.classicParametricSyntax,f=void 0!==l&&l,d=t.forceObjects,m=void 0!==d&&d,v=t.debug,g=void 0!==v&&v;this.ignoredSymbols=a,this.debug=g,this.branchSymbols=n,this.allowClassicSyntax=u,this.classicParametricSyntax=f,this.forceObjects=m,this.setAxiom(i),this.clearProductions(),o&&this.setProductions(o),r&&this.setFinals(r)}var o=LSystem.prototype;return o.setAxiom=function(t){this.axiom=this.forceObjects?s(t):t},o.getRaw=function(){return this.axiom},o.getString=function(t){return void 0===t&&(t=!0),"string"==typeof this.axiom?this.axiom:!0===t?this.axiom.reduce(function(t,s){if(void 0===s.symbol)throw console.log("found:",s),new Error("L-Systems that use only objects as symbols (eg: {symbol: 'F', params: []}), cant use string symbols (eg. 'F')! Check if you always return objects in your productions and no strings.");return t+s.symbol},""):JSON.stringify(this.axiom)},o.setProduction=function(s,o,r){void 0===r&&(r=!1);var e=[s,o];if(void 0===e)throw new Error("no production specified.");if(o.successor&&o.successors)throw new Error('You can not have both a "successor" and a "successors" field in your production!');if(!0===this.allowClassicSyntax&&(e=t(e)),(e=i(e,this.forceObjects))[1].isStochastic=void 0!==e[1].successors&&e[1].successors.every(function(t){return void 0!==t.weight}),e[1].isStochastic){e[1].weightSum=0;for(var n=0,c=e[1].successors;n<c.length;n++){var a=c[n];e[1].weightSum+=a.weight}}var h=e[0];if(!0===r&&this.productions.has(h)){var u=this.productions.get(h),l=u.successor,f=u.successors;l&&!f&&(u={successors:[u]}),u.successors.push(e[1]),this.productions.set(h,u)}else this.productions.set(h,e[1])},o.setProductions=function(t){if(void 0===t)throw new Error("no production specified.");this.clearProductions();for(var s=0,i=Object.entries(t);s<i.length;s++){var o=i[s],r=o[0],e=o[1];this.setProduction(r,e,!0)}},o.clearProductions=function(){this.productions=new Map},o.setFinal=function(t,s){var i=[t,s];if(void 0===i)throw new Error("no final specified.");this.finals.set(i[0],i[1])},o.setFinals=function(t){if(void 0===t)throw new Error("no finals specified.");for(var s in this.finals=new Map,t)t.hasOwnProperty(s)&&this.setFinal(s,t[s])},o.getProductionResult=function(t,s,i,o,r){void 0===r&&(r=!1);var e=void 0!==t.leftCtx||void 0!==t.rightCtx,n=!1,c=!0;if(void 0!==t.condition&&!1===t.condition({index:s,currentAxiom:this.axiom,part:i,params:o})?c=!1:e&&(void 0!==t.leftCtx&&void 0!==t.rightCtx?c=this.match({direction:"left",match:t.leftCtx,index:s,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result&&this.match({direction:"right",match:t.rightCtx,index:s,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result:void 0!==t.leftCtx?c=this.match({direction:"left",match:t.leftCtx,index:s,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result:void 0!==t.rightCtx&&(c=this.match({direction:"right",match:t.rightCtx,index:s,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result)),!1===c)n=!1;else if(t.successors){var a,h;t.isStochastic&&(h=Math.random()*t.weightSum,a=0);for(var u=0,l=t.successors;u<l.length;u++){var f=l[u];if(!(t.isStochastic&&(a+=f.weight)<h)){var d=this.getProductionResult(f,s,i,o,!0);if(void 0!==d&&!1!==d){n=d;break}}}}else n="function"==typeof t.successor?t.successor({index:s,currentAxiom:this.axiom,part:i,params:o}):t.successor;return n||(r?n:i)},o.applyProductions=function(){for(var t="string"==typeof this.axiom?"":[],s=0,i=0,o=this.axiom;i<o.length;i++){var r=o[i],e=r.symbol||r,n=r.params||[],c=r;if(this.productions.has(e)){var a=this.productions.get(e);c=this.getProductionResult(a,s,r,n)}if("string"==typeof t)t+=c;else if(c instanceof Array){var h;(h=t).push.apply(h,c)}else t.push(c);s++}return this.axiom=t,t},o.iterate=function(t){var s;void 0===t&&(t=1),this.iterations=t;for(var i=0;i<t;i++)s=this.applyProductions();return s},o.final=function(t){for(var s=0,i=0,o=this.axiom;i<o.length;i++){var r=o[i],e=r;if("object"==typeof r&&r.symbol&&(e=r.symbol),this.finals.has(e)){var n=this.finals.get(e),c=typeof n;if("function"!==c)throw Error("'"+e+"' has an object for a final function. But it is __not a function__ but a "+c+"!");n({index:s,part:r},t)}s++}},o.match=function(t){var s=t.axiom_,i=t.match,o=t.ignoredSymbols,r=t.branchSymbols,e=t.index,n=t.direction,c=0,a=0;s=s||this.axiom,void 0===r&&(r=void 0!==this.branchSymbols?this.branchSymbols:[]),void 0===o&&(o=void 0!==this.ignoredSymbols?this.ignoredSymbols:[]);var h,u,l,f,d,m,v,g=[];if("right"===n){if(f=m=1,l=e+1,d=0,v=i.length,r.length>0){var y=r;h=y[0],u=y[1]}}else{if("left"!==n)throw Error(n,"is not a valid direction for matching.");if(f=m=-1,l=e-1,d=i.length-1,v=-1,r.length>0){var b=r;u=b[0],h=b[1]}}for(;l<s.length&&l>=0;l+=f){var p=s[l].symbol||s[l],x=i[d];if(p===x){if((0===c||a>0)&&(p===h?(a++,c++,d+=m):p===u?(a=Math.max(0,a-1),c=Math.max(0,c-1),0===a&&(d+=m)):(g.push(l),d+=m)),d===v)return{result:!0,matchIndices:g}}else if(p===h)c++,a>0&&a++;else if(p===u)c=Math.max(0,c-1),a>0&&(a=Math.max(0,a-1));else if((0===c||a>0&&x!==u)&&!1===o.includes(p))return{result:!1,matchIndices:g}}return{result:!1,matchIndices:g}},LSystem}();return LSystem.getStringResult=LSystem.getString,LSystem.transformClassicStochasticProductions=function(t){return function(){for(var s=t,i=s.length,o=Math.random(),r=0;r<i;r++)if(o<=(r+1)/i)return s[r];console.error("Should have returned a result of the list, something is wrong here with the random numbers?.")}},LSystem.transformClassicCSProduction=t,LSystem.transformClassicParametricAxiom=function(t){for(var s=t.replace(/\s+/g,"").split(/[\(\)]/),i=[],o=0;o<s.length-1;o+=2){var r=s[o+1].split(",").map(Number);i.push({symbol:s[o],params:r})}},LSystem.testClassicParametricSyntax=function(t){return/\(.+\)/.test(t)},LSystem});
