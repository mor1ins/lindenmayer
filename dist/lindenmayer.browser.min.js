var LSystem=function(){"use strict";function t(t){var s,r=t[0].match(/(.+)<(.)/),i=t[0].match(/(.)>(.+)/);if(null===r&&null===i)return t;var o=t[1].successor||t[1].successors?t[1]:{successor:t[1]};return null!==r&&(s=r[2],o.leftCtx=r[1]),null!==i&&(s=i[1],o.rightCtx=i[2]),[s,o]}function s(t){if("string"!=typeof t&&t instanceof String==!1)return t;var s=[],r=t,i=Array.isArray(r),o=0;for(r=i?r:r[Symbol.iterator]();;){var e;if(i){if(o>=r.length)break;e=r[o++]}else{if((o=r.next()).done)break;e=o.value}var n=e;s.push({symbol:n})}return s}function r(t,r){return t[1]=function t(r,i){if(r.hasOwnProperty("successors"))for(var o=0;o<r.successors.length;o++)r.successors[o]=t(r.successors[o],i);else!1===r.hasOwnProperty("successor")&&(r={successor:r});return i&&r.hasOwnProperty("successor")&&(r.successor=s(r.successor)),r}(t[1],r),t}Object.entries||(Object.entries=function(t){for(var s=Object.keys(t),r=s.length,i=new Array(r);r--;)i[r]=[s[r],t[s[r]]];return i});var LSystem=function(){function LSystem(t){var s=t.axiom,r=void 0===s?"":s,i=t.productions,o=t.finals,e=t.branchSymbols,n=void 0===e?"[]":e,a=t.ignoredSymbols,c=void 0===a?"+-&^/|\\":a,h=t.allowClassicSyntax,u=void 0===h||h,l=t.classicParametricSyntax,f=void 0!==l&&l,d=t.forceObjects,m=void 0!==d&&d,v=t.debug,b=void 0!==v&&v;this.ignoredSymbols=c,this.debug=b,this.branchSymbols=n,this.allowClassicSyntax=u,this.classicParametricSyntax=f,this.forceObjects=m,this.setAxiom(r),this.clearProductions(),i&&this.setProductions(i),o&&this.setFinals(o)}var i=LSystem.prototype;return i.setAxiom=function(t){this.axiom=this.forceObjects?s(t):t},i.getRaw=function(){return this.axiom},i.getString=function(t){return void 0===t&&(t=!0),"string"==typeof this.axiom?this.axiom:!0===t?this.axiom.reduce(function(t,s){if(void 0===s.symbol)throw console.log("found:",s),new Error("L-Systems that use only objects as symbols (eg: {symbol: 'F', params: []}), cant use string symbols (eg. 'F')! Check if you always return objects in your productions and no strings.");return t+s.symbol},""):JSON.stringify(this.axiom)},i.setProduction=function(s,i,o){void 0===o&&(o=!1);var e=[s,i];if(void 0===e)throw new Error("no production specified.");if(i.successor&&i.successors)throw new Error('You can not have both a "successor" and a "successors" field in your production!');if(!0===this.allowClassicSyntax&&(e=t(e)),(e=r(e,this.forceObjects))[1].isStochastic=void 0!==e[1].successors&&e[1].successors.every(function(t){return void 0!==t.weight}),e[1].isStochastic){e[1].weightSum=0;var n=e[1].successors,a=Array.isArray(n),c=0;for(n=a?n:n[Symbol.iterator]();;){var h;if(a){if(c>=n.length)break;h=n[c++]}else{if((c=n.next()).done)break;h=c.value}var u=h;e[1].weightSum+=u.weight}}var l=e[0];if(!0===o&&this.productions.has(l)){var f=this.productions.get(l),d=f.successor,m=f.successors;d&&!m&&(f={successors:[f]}),f.successors.push(e[1]),this.productions.set(l,f)}else this.productions.set(l,e[1])},i.setProductions=function(t){if(void 0===t)throw new Error("no production specified.");this.clearProductions();for(var s=0,r=Object.entries(t);s<r.length;s++){var i=r[s],o=i[0],e=i[1];this.setProduction(o,e,!0)}},i.clearProductions=function(){this.productions=new Map},i.setFinal=function(t,s){var r=[t,s];if(void 0===r)throw new Error("no final specified.");this.finals.set(r[0],r[1])},i.setFinals=function(t){if(void 0===t)throw new Error("no finals specified.");for(var s in this.finals=new Map,t)t.hasOwnProperty(s)&&this.setFinal(s,t[s])},i.getProductionResult=function(t,s,r,i,o){void 0===o&&(o=!1);var e=void 0!==t.leftCtx||void 0!==t.rightCtx,n=!1,a=!0;if(void 0!==t.condition&&!1===t.condition({index:s,currentAxiom:this.axiom,part:r,params:i})?a=!1:e&&(void 0!==t.leftCtx&&void 0!==t.rightCtx?a=this.match({direction:"left",match:t.leftCtx,index:s,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result&&this.match({direction:"right",match:t.rightCtx,index:s,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result:void 0!==t.leftCtx?a=this.match({direction:"left",match:t.leftCtx,index:s,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result:void 0!==t.rightCtx&&(a=this.match({direction:"right",match:t.rightCtx,index:s,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result)),!1===a)n=!1;else if(t.successors){var c,h;t.isStochastic&&(h=Math.random()*t.weightSum,c=0);var u=t.successors,l=Array.isArray(u),f=0;for(u=l?u:u[Symbol.iterator]();;){var d;if(l){if(f>=u.length)break;d=u[f++]}else{if((f=u.next()).done)break;d=f.value}var m=d;if(!(t.isStochastic&&(c+=m.weight)<h)){var v=this.getProductionResult(m,s,r,i,!0);if(void 0!==v&&!1!==v){n=v;break}}}}else n="function"==typeof t.successor?t.successor({index:s,currentAxiom:this.axiom,part:r,params:i}):t.successor;return n||(o?n:r)},i.applyProductions=function(){var t="string"==typeof this.axiom?"":[],s=0,r=this.axiom,i=Array.isArray(r),o=0;for(r=i?r:r[Symbol.iterator]();;){var e;if(i){if(o>=r.length)break;e=r[o++]}else{if((o=r.next()).done)break;e=o.value}var n=e,a=n.symbol||n,c=n.params||[],h=n;if(this.productions.has(a)){var u=this.productions.get(a);h=this.getProductionResult(u,s,n,c)}if("string"==typeof t)t+=h;else if(h instanceof Array){var l;(l=t).push.apply(l,h)}else t.push(h);s++}return this.axiom=t,t},i.iterate=function(t){var s;void 0===t&&(t=1),this.iterations=t;for(var r=0;r<t;r++)s=this.applyProductions();return s},i.final=function(t){var s=0,r=this.axiom,i=Array.isArray(r),o=0;for(r=i?r:r[Symbol.iterator]();;){var e;if(i){if(o>=r.length)break;e=r[o++]}else{if((o=r.next()).done)break;e=o.value}var n=e,a=n;if("object"==typeof n&&n.symbol&&(a=n.symbol),this.finals.has(a)){var c=this.finals.get(a),h=typeof c;if("function"!==h)throw Error("'"+a+"' has an object for a final function. But it is __not a function__ but a "+h+"!");c({index:s,part:n},t)}s++}},i.match=function(t){var s=t.axiom_,r=t.match,i=t.ignoredSymbols,o=t.branchSymbols,e=t.index,n=t.direction,a=0,c=0;s=s||this.axiom,void 0===o&&(o=void 0!==this.branchSymbols?this.branchSymbols:[]),void 0===i&&(i=void 0!==this.ignoredSymbols?this.ignoredSymbols:[]);var h,u,l,f,d,m,v,b=[];if("right"===n){if(f=m=1,l=e+1,d=0,v=r.length,o.length>0){var y=o;h=y[0],u=y[1]}}else{if("left"!==n)throw Error(n,"is not a valid direction for matching.");if(f=m=-1,l=e-1,d=r.length-1,v=-1,o.length>0){var g=o;u=g[0],h=g[1]}}for(;l<s.length&&l>=0;l+=f){var p=s[l].symbol||s[l],x=r[d];if(p===x){if((0===a||c>0)&&(p===h?(c++,a++,d+=m):p===u?(c=Math.max(0,c-1),a=Math.max(0,a-1),0===c&&(d+=m)):(b.push(l),d+=m)),d===v)return{result:!0,matchIndices:b}}else if(p===h)a++,c>0&&c++;else if(p===u)a=Math.max(0,a-1),c>0&&(c=Math.max(0,c-1));else if((0===a||c>0&&x!==u)&&!1===i.includes(p))return{result:!1,matchIndices:b}}return{result:!1,matchIndices:b}},LSystem}();return LSystem.getStringResult=LSystem.getString,LSystem.transformClassicStochasticProductions=function(t){return function(){for(var s=t,r=s.length,i=Math.random(),o=0;o<r;o++)if(i<=(o+1)/r)return s[o];console.error("Should have returned a result of the list, something is wrong here with the random numbers?.")}},LSystem.transformClassicCSProduction=t,LSystem.transformClassicParametricAxiom=function(t){for(var s=t.replace(/\s+/g,"").split(/[\(\)]/),r=[],i=0;i<s.length-1;i+=2){var o=s[i+1].split(",").map(Number);r.push({symbol:s[i],params:o})}},LSystem.testClassicParametricSyntax=function(t){return/\(.+\)/.test(t)},LSystem}();
